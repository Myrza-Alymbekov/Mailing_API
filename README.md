# API для сервиса уведомлений

Сервис управления рассылками API администрирования и получения статистики.


## Инструкция по установке проекта

1. Спулить код с репозитория main.
2. Создать файл entrypoint.sh в директории app.
   1. Вставить в этот файл следующий код:
    ```
    #!/bin/sh

    if [ "$DATABASE" = "postgres" ]
    then
        echo "Waiting for postgres..."
    
        while ! nc -z $SQL_HOST $SQL_PORT; do
          sleep 0.1
        done
    
        echo "PostgreSQL started"
    fi
    
    python manage.py migrate
    
    exec "$@"

    ```
   2. Если операционная система Mac или Linux прописать команду в терминале:
    ```
   chmod +x entrypoint.sh
    ```
3. Запустить сборку контейнеров командой:
```
docker-compose up -d --build
```
## Инструкция по использованию

1. Перейти по ссылке: localhost:8000 и в открывшемся интерфейсе RestFramework перейти по ссылке /tags
2. Создать нужное количество тегов
3. Перейти по ссылке /clients и создать нужное количество клиентов
4. Перейти по ссылке /mailings и создать рассылку

## Реализованный функционал

- После создания рассылки можно сразу увидеть статистику по отправленным сообщениям по этой рассылке
  (Сообщения создаются со статусом "В процессе" и в дальнейшем меняют статус на "Доставлено" или "Не отправлено" в зависимости от успешной/неуспешной отправки)
- Общую статистику по рассылкам и сообщениям можно посмотреть перейдя по ссылке: /mailing-statistics
- Также статистику по фоновым и отложенным таскам можно посмотреть в интерфейсе Flower, перейдя по ссылке: /localhost:5555
- Общую и детальную информацию по всем созданным клиентам, тегам, рассылкам и сообщениям можно посмотреть в административной панели Джанго, перейдя по ссылке: /admin
- Документацию к API можно посмотреть перейдя по ссылкам: /swagger и /redoc



## Логика рассылки

- При создании рассылки, отбираются клиенты подходящие по фильтрам Тега и Кода оператора.
- Затем создаются сообщения адресованные этим клиентам, со статусом "В процессе" и с временем создания равной времени начала отправки рассылки.
- В зависимости от начала и конца времени отправки рассылки, создается task. Если время начала рассылки равно или меньше текущего времени, то создается task в фоновом режиме, а если больше - то создается отложенный task с задержкой равной разнице текущего времени и времени начала рассылки.
- При отправке рассылки, учитывается временной пояс клиента(т.е. если у клиента временной пояс, отстающий от локального('Europe/Moscow') на час, то создается отдельный отложенный task с временем задержки равной одному часу).
- При выполнении таска отправляется запрос на внешний API-сервис с предоставлением JWT-токена.
- В зависимости от полученного ответа, меняется статус сообщения на "Доставлено" или "Не отправлено".



## Выполненные дополнительные задания

- Программа обернута в docker-контейнера и реализована автоматическая сборка всех контейнеров с помощью docker-compose(Контейнеры: Web, Postgres-DB, Celery, Redis, Flower).
- Реализована документация проекта с использованием Swagger и Redoc.
